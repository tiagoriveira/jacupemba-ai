# ğŸ—ï¸ ARQUITETURA - Busca SemÃ¢ntica Jacupemba AI

VisÃ£o completa da arquitetura do sistema de busca semÃ¢ntica.

---

## ğŸ“Š DIAGRAMA DE FLUXO GERAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USUÃRIO                              â”‚
â”‚                     "Onde posso comer                       â”‚
â”‚                      algo rÃ¡pido?"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   INTERFACE (Chat UI)                       â”‚
â”‚                  app/page.tsx                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP POST /api/chat
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               AGENTE AI (Grok 3)                            â”‚
â”‚          app/api/chat/route.ts                              â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ System Prompt + Context                              â”‚  â”‚
â”‚  â”‚ - InstruÃ§Ãµes do agente                               â”‚  â”‚
â”‚  â”‚ - Dados do bairro (relatos, comercios, etc.)        â”‚  â”‚
â”‚  â”‚ - Ferramentas disponÃ­veis                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ DECISÃƒO: Qual ferramenta usar?                       â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚ [buscarSemantico] â† Pergunta complexa/sinÃ´nimos     â”‚  â”‚
â”‚  â”‚ [buscarRelatos]   â† Categoria especÃ­fica            â”‚  â”‚
â”‚  â”‚ [buscarComercio]  â† Nome/tipo exato                 â”‚  â”‚
â”‚  â”‚ [obterEstatisticas] â† NÃºmeros/tendÃªncias            â”‚  â”‚
â”‚  â”‚ [analisarSentimento] â† ReputaÃ§Ã£o                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                   â”‚
        â–¼ (Busca SemÃ¢ntica)                 â–¼ (Busca Tradicional)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BUSCA SEMÃ‚NTICA (RAG)     â”‚    â”‚  BUSCA TRADICIONAL       â”‚
â”‚  lib/embeddings.ts         â”‚    â”‚  SQL WHERE + LIKE        â”‚
â”‚                            â”‚    â”‚                          â”‚
â”‚  1. Gera embedding         â”‚    â”‚  SELECT * FROM ...       â”‚
â”‚     da pergunta            â”‚    â”‚  WHERE text LIKE '%X%'   â”‚
â”‚                            â”‚    â”‚                          â”‚
â”‚  2. Busca similar no       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚     pgvector               â”‚                 â”‚
â”‚                            â”‚                 â”‚
â”‚  3. Retorna top-N          â”‚                 â”‚
â”‚     (threshold > 0.7)      â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
             â”‚                                 â”‚
             â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BANCO DE DADOS                             â”‚
â”‚                  Supabase PostgreSQL                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ anonymous_reports  â”‚  â”‚ local_businesses   â”‚            â”‚
â”‚  â”‚ - id               â”‚  â”‚ - id               â”‚            â”‚
â”‚  â”‚ - text             â”‚  â”‚ - name             â”‚            â”‚
â”‚  â”‚ - category         â”‚  â”‚ - category         â”‚            â”‚
â”‚  â”‚ - status           â”‚  â”‚ - description      â”‚            â”‚
â”‚  â”‚ - created_at       â”‚  â”‚ - phone            â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                       â”‚                        â”‚
â”‚           â”‚                       â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ report_embeddings  â”‚  â”‚business_embeddings â”‚            â”‚
â”‚  â”‚ - id               â”‚  â”‚ - id               â”‚            â”‚
â”‚  â”‚ - report_id (FK)   â”‚  â”‚ - business_id (FK) â”‚            â”‚
â”‚  â”‚ - embedding        â”‚  â”‚ - embedding        â”‚            â”‚
â”‚  â”‚   vector(1536)     â”‚  â”‚   vector(1536)     â”‚            â”‚
â”‚  â”‚ [HNSW Index]       â”‚  â”‚ [HNSW Index]       â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FUNÃ‡Ã•ES SQL                                          â”‚  â”‚
â”‚  â”‚ - search_reports_semantic(embedding, threshold)      â”‚  â”‚
â”‚  â”‚ - search_businesses_semantic(embedding, threshold)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   RESPOSTA   â”‚
                  â”‚   ao usuÃ¡rio â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUXO DETALHADO: BUSCA SEMÃ‚NTICA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USUÃRIO FAZ PERGUNTA                                    â”‚
â”‚    "Onde posso comer algo rÃ¡pido?"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. AGENTE ANALISA                                          â”‚
â”‚    - Pergunta tem sinÃ´nimos? âœ“                             â”‚
â”‚    - Conceito abstrato? âœ“                                  â”‚
â”‚    - Busca tradicional suficiente? âœ—                       â”‚
â”‚    DECISÃƒO: Usar buscarSemantico                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. GERAR EMBEDDING DA PERGUNTA                             â”‚
â”‚    lib/embeddings.ts â†’ generateEmbedding()                 â”‚
â”‚                                                            â”‚
â”‚    Input: "Onde posso comer algo rÃ¡pido?"                  â”‚
â”‚           â†“                                                â”‚
â”‚    OpenAI text-embedding-3-small (via AI Gateway)          â”‚
â”‚           â†“                                                â”‚
â”‚    Output: [0.234, -0.456, 0.678, ..., 0.123]             â”‚
â”‚           (vetor de 1536 nÃºmeros)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. BUSCAR NO BANCO (pgvector)                              â”‚
â”‚    searchBusinessesSemantic(pergunta, options)             â”‚
â”‚                                                            â”‚
â”‚    SQL: SELECT * FROM search_businesses_semantic(          â”‚
â”‚           query_embedding = [0.234, ...],                  â”‚
â”‚           match_threshold = 0.7,                           â”‚
â”‚           match_count = 10                                 â”‚
â”‚         )                                                  â”‚
â”‚                                                            â”‚
â”‚    Como funciona:                                          â”‚
â”‚    1. Calcula distÃ¢ncia coseno entre query_embedding       â”‚
â”‚       e cada business_embedding                            â”‚
â”‚    2. Filtra resultados > threshold (0.7)                  â”‚
â”‚    3. Ordena por similaridade (mais similar primeiro)      â”‚
â”‚    4. Limita a 10 resultados                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RESULTADOS RETORNADOS                                   â”‚
â”‚                                                            â”‚
â”‚    [                                                       â”‚
â”‚      {                                                     â”‚
â”‚        nome: "Lanchonete do JoÃ£o",                         â”‚
â”‚        categoria: "alimentacao",                           â”‚
â”‚        telefone: "(21) 9999-9999",                         â”‚
â”‚        similarity: 0.92  â† 92% similar!                    â”‚
â”‚      },                                                    â”‚
â”‚      {                                                     â”‚
â”‚        nome: "Fast Food Center",                           â”‚
â”‚        categoria: "alimentacao",                           â”‚
â”‚        telefone: "(21) 8888-8888",                         â”‚
â”‚        similarity: 0.95  â† 95% similar!                    â”‚
â”‚      },                                                    â”‚
â”‚      ...                                                   â”‚
â”‚    ]                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. AGENTE FORMATA RESPOSTA                                 â”‚
â”‚                                                            â”‚
â”‚    "Encontrei 5 opÃ§Ãµes de alimentaÃ§Ã£o rÃ¡pida:             â”‚
â”‚                                                            â”‚
â”‚     1. Fast Food Center (95% relevante)                    â”‚
â”‚        Telefone: (21) 8888-8888                            â”‚
â”‚        Categoria: AlimentaÃ§Ã£o                              â”‚
â”‚                                                            â”‚
â”‚     2. Lanchonete do JoÃ£o (92% relevante)                  â”‚
â”‚        Telefone: (21) 9999-9999                            â”‚
â”‚        Categoria: AlimentaÃ§Ã£o                              â”‚
â”‚                                                            â”‚
â”‚     ..."                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. USUÃRIO RECEBE RESPOSTA                                 â”‚
â”‚    âœ“ Resultados relevantes                                 â”‚
â”‚    âœ“ Ordenados por similaridade                            â”‚
â”‚    âœ“ Com score de confianÃ§a                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ COMPONENTES PRINCIPAIS

### 1. Interface (Frontend)
```
app/page.tsx
â”œâ”€â”€ ChatInterface
â”œâ”€â”€ MessageList
â”œâ”€â”€ InputForm
â””â”€â”€ AgentSettings (localStorage)
```

### 2. API Backend
```
app/api/chat/route.ts
â”œâ”€â”€ POST handler
â”‚   â”œâ”€â”€ Load context (relatos, comercios, etc.)
â”‚   â”œâ”€â”€ Read agent config (headers)
â”‚   â”œâ”€â”€ Build system prompt
â”‚   â””â”€â”€ Stream AI response
â”‚
â””â”€â”€ Tools (ferramentas)
    â”œâ”€â”€ buscarSemantico [NOVO!]
    â”œâ”€â”€ buscarRelatos
    â”œâ”€â”€ buscarComercio
    â”œâ”€â”€ obterEstatisticas
    â””â”€â”€ analisarSentimento
```

### 3. Biblioteca de Embeddings
```
lib/embeddings.ts
â”œâ”€â”€ generateEmbedding(text)
â”œâ”€â”€ prepareReportText(report)
â”œâ”€â”€ prepareBusinessText(business)
â”œâ”€â”€ searchReportsSemantic(query, options)
â””â”€â”€ searchBusinessesSemantic(query, options)
```

### 4. ConfiguraÃ§Ã£o
```
lib/embedding-config.ts
â”œâ”€â”€ EMBEDDING_CONFIG
â”‚   â”œâ”€â”€ model: "openai/text-embedding-3-small"
â”‚   â”œâ”€â”€ dimension: 1536
â”‚   â”œâ”€â”€ defaultThreshold: 0.7
â”‚   â””â”€â”€ defaultLimit: 10
â”‚
â”œâ”€â”€ REPORT_CATEGORIES
â”œâ”€â”€ BUSINESS_CATEGORIES
â””â”€â”€ SEMANTIC_EXAMPLES
```

### 5. Script de GeraÃ§Ã£o
```
scripts/generate-embeddings.ts
â”œâ”€â”€ generateReportEmbeddings()
â”‚   â”œâ”€â”€ Fetch approved reports
â”‚   â”œâ”€â”€ Generate embeddings
â”‚   â””â”€â”€ Save to database
â”‚
â””â”€â”€ generateBusinessEmbeddings()
    â”œâ”€â”€ Fetch verified businesses
    â”œâ”€â”€ Generate embeddings
    â””â”€â”€ Save to database
```

### 6. Banco de Dados (Supabase)
```
PostgreSQL + pgvector
â”œâ”€â”€ anonymous_reports (tabela principal)
â”œâ”€â”€ local_businesses (tabela principal)
â”œâ”€â”€ report_embeddings (vetores dos relatos)
â”œâ”€â”€ business_embeddings (vetores dos comercios)
â”‚
â””â”€â”€ FunÃ§Ãµes SQL
    â”œâ”€â”€ search_reports_semantic()
    â””â”€â”€ search_businesses_semantic()
```

---

## ğŸš€ FLUXO DE GERAÃ‡ÃƒO DE EMBEDDINGS (Setup)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMANDO: npm run generate-embeddings                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. BUSCAR RELATOS APROVADOS                                â”‚
â”‚    SELECT * FROM anonymous_reports                         â”‚
â”‚    WHERE status = 'aprovado'                               â”‚
â”‚                                                            â”‚
â”‚    Resultado: 150 relatos                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. PROCESSAR CADA RELATO                                   â”‚
â”‚                                                            â”‚
â”‚    Para cada relato (1-150):                               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚ a) Preparar texto                            â”‚       â”‚
â”‚    â”‚    "seguranca: Roubo na Rua Principal..."   â”‚       â”‚
â”‚    â”‚                                              â”‚       â”‚
â”‚    â”‚ b) Gerar embedding (OpenAI API)              â”‚       â”‚
â”‚    â”‚    [0.23, -0.45, 0.67, ..., 0.12]          â”‚       â”‚
â”‚    â”‚                                              â”‚       â”‚
â”‚    â”‚ c) Salvar no banco                           â”‚       â”‚
â”‚    â”‚    INSERT INTO report_embeddings            â”‚       â”‚
â”‚    â”‚    (report_id, embedding)                    â”‚       â”‚
â”‚    â”‚                                              â”‚       â”‚
â”‚    â”‚ d) Aguardar 100ms (rate limit)              â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                            â”‚
â”‚    Progress: âœ… 150/150 relatos processados                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. BUSCAR COMERCIOS VERIFICADOS                            â”‚
â”‚    SELECT * FROM local_businesses                          â”‚
â”‚    WHERE status = 'aprovado' AND verified = true           â”‚
â”‚                                                            â”‚
â”‚    Resultado: 80 comercios                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. PROCESSAR CADA COMERCIO                                 â”‚
â”‚                                                            â”‚
â”‚    Para cada comercio (1-80):                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚ a) Preparar texto                            â”‚       â”‚
â”‚    â”‚    "alimentacao - Padaria Central - PÃ£es e  â”‚       â”‚
â”‚    â”‚     produtos de padaria artesanal"          â”‚       â”‚
â”‚    â”‚                                              â”‚       â”‚
â”‚    â”‚ b) Gerar embedding (OpenAI API)              â”‚       â”‚
â”‚    â”‚    [0.12, 0.89, -0.34, ..., 0.56]          â”‚       â”‚
â”‚    â”‚                                              â”‚       â”‚
â”‚    â”‚ c) Salvar no banco                           â”‚       â”‚
â”‚    â”‚    INSERT INTO business_embeddings          â”‚       â”‚
â”‚    â”‚    (business_id, embedding)                  â”‚       â”‚
â”‚    â”‚                                              â”‚       â”‚
â”‚    â”‚ d) Aguardar 100ms (rate limit)              â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                            â”‚
â”‚    Progress: âœ… 80/80 comercios processados                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. CONCLUÃDO!                                              â”‚
â”‚    âœ… 150 report_embeddings criados                         â”‚
â”‚    âœ… 80 business_embeddings criados                        â”‚
â”‚    âœ… Sistema pronto para busca semÃ¢ntica                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” SEGURANÃ‡A E PERFORMANCE

### Rate Limiting
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI API                          â”‚
â”‚ (via Vercel AI Gateway)             â”‚
â”‚                                     â”‚
â”‚ Limite: ~3000 requests/min          â”‚
â”‚                                     â”‚
â”‚ Nossa config:                       â”‚
â”‚ 100ms delay = 600 requests/min âœ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ãndices para Performance
```sql
-- HNSW = Hierarchical Navigable Small World
-- Algoritmo eficiente para busca em alta dimensÃ£o

CREATE INDEX report_embeddings_idx 
ON report_embeddings 
USING hnsw (embedding vector_cosine_ops);

Performance:
- Busca em ~2ms (vs 200ms sem Ã­ndice)
- Escala para milhÃµes de vetores
- PrecisÃ£o: ~99%
```

### Cache (Futuro)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query: "comida rÃ¡pida"                â”‚
â”‚   â†“                                   â”‚
â”‚ Embedding jÃ¡ gerado? Check cache      â”‚
â”‚   â†“                                   â”‚
â”‚ Se sim: Reutilizar (0ms)              â”‚
â”‚ Se nÃ£o: Gerar novo (150ms)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š MÃ‰TRICAS E MONITORAMENTO

### Logs de Debug
```javascript
console.log("[v0] Busca semantica em relatos: 'comida rapida'")
console.log("[v0] 8 relatos encontrados")
console.log("[v0] Busca semantica em comercios: 'comida rapida'")
console.log("[v0] 5 comercios encontrados")
```

### Queries SQL para Monitoramento
```sql
-- Total de embeddings
SELECT 
  (SELECT COUNT(*) FROM report_embeddings) as relatos,
  (SELECT COUNT(*) FROM business_embeddings) as comercios;

-- Taxa de cobertura
SELECT 
  (SELECT COUNT(*) FROM report_embeddings)::float / 
  (SELECT COUNT(*) FROM anonymous_reports WHERE status = 'aprovado') * 100 
  as coverage_percentage;

-- Ãšltimos embeddings criados
SELECT * FROM report_embeddings 
ORDER BY created_at DESC LIMIT 10;
```

---

## ğŸ¯ DECISÃƒO DO AGENTE: Qual Tool Usar?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PERGUNTA DO USUÃRIO                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Analisar caracterÃ­sticas:  â”‚
         â”‚ - Tem sinÃ´nimos?           â”‚
         â”‚ - Conceito abstrato?       â”‚
         â”‚ - Pergunta complexa?       â”‚
         â”‚ - Categoria especÃ­fica?    â”‚
         â”‚ - Nome exato?              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            â”‚
        â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Busca SemÃ¢ntica  â”‚        â”‚ Busca Tradicionalâ”‚
â”‚                  â”‚        â”‚                  â”‚
â”‚ âœ“ SinÃ´nimos      â”‚        â”‚ âœ“ Categoria      â”‚
â”‚ âœ“ Conceitos      â”‚        â”‚ âœ“ Nome exato     â”‚
â”‚ âœ“ Complexa       â”‚        â”‚ âœ“ Filtros        â”‚
â”‚                  â”‚        â”‚ âœ“ EstatÃ­sticas   â”‚
â”‚ buscarSemantico  â”‚        â”‚ outras tools     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Exemplos de DecisÃ£o

| Pergunta | Tool Escolhida | Motivo |
|----------|---------------|--------|
| "comida rÃ¡pida" | buscarSemantico | SinÃ´nimos |
| "relatos de seguranÃ§a" | buscarRelatos | Categoria especÃ­fica |
| "Padaria Central" | buscarComercio | Nome exato |
| "estatÃ­sticas do bairro" | obterEstatisticas | NÃºmeros |
| "lugar tranquilo" | buscarSemantico | Conceito abstrato |
| "Padaria Ã© boa?" | analisarSentimento | ReputaÃ§Ã£o |

---

## ğŸ”® FUTURAS MELHORIAS (FASE 2 e 3)

### FASE 2: MemÃ³ria Persistente
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_conversations                     â”‚
â”‚ - id                                   â”‚
â”‚ - user_fingerprint                     â”‚
â”‚ - messages (JSONB)                     â”‚
â”‚ - created_at                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_preferences                       â”‚
â”‚ - id                                   â”‚
â”‚ - user_fingerprint                     â”‚
â”‚ - preferences (JSONB)                  â”‚
â”‚   {                                    â”‚
â”‚     "favorite_categories": ["food"],   â”‚
â”‚     "frequent_searches": [...]         â”‚
â”‚   }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### FASE 3: AÃ§Ãµes Proativas
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_notifications                     â”‚
â”‚ - id                                   â”‚
â”‚ - user_fingerprint                     â”‚
â”‚ - notification_type                    â”‚
â”‚ - content                              â”‚
â”‚ - read                                 â”‚
â”‚ - created_at                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š RECURSOS ADICIONAIS

- **DocumentaÃ§Ã£o TÃ©cnica:** `SEMANTIC_SEARCH.md`
- **Guia RÃ¡pido:** `QUICKSTART_SEMANTIC.md`
- **ComparaÃ§Ã£o Antes/Depois:** `ANTES_DEPOIS.md`
- **Resumo de ImplementaÃ§Ã£o:** `IMPLEMENTATION_SUMMARY.md`
- **Checklist de Deploy:** `DEPLOYMENT_CHECKLIST.md`

---

Arquitetura documentada para Jacupemba AI ğŸ—ï¸
